version: '0.1.{build}'

branches:
  except:
    - travis

image: Visual Studio 2019

environment:
  PREMAKE_VERSION: "5.0.0-alpha15"

install:
  # Dependencies required by the CI are installed in ${clone_folder}/deps/
  - set DEPS_DIR="%clone_folder%\deps"
  - if not exist "%DEPS_DIR%" mkdir "%DEPS_DIR%"
  - pushd "%DEPS_DIR%"

  # Download premake binary for current platform if not already done via cache (also check version just in case)
  # We simplified checks compared to .travis.yml to make it easier to write in batch
  # but eventually we can re-add them in PowerShell which is much more powerful 
  - |
    if not exist "premake-%PREMAKE_VERSION%" mkdir "premake-%PREMAKE_VERSION%"
    pushd "premake-%PREMAKE_VERSION%"

    set PREMAKE_BINARY_OS_NAME="windows"
    curl "https://github.com/premake/premake-core/releases/download/v%PREMAKE_VERSION%/premake-%PREMAKE_VERSION%-%PREMAKE_BINARY_OS_NAME%.zip"
    rmdir /s /q "premake-%PREMAKE_VERSION%"
    tar -xvf "premake-%PREMAKE_VERSION%-%PREMAKE_BINARY_OS_NAME%.zip"

    popd
  # No canonical path on AppVeyor Windows to copy premake to,
  # so add premake location to PATH
  - set PATH="premake-%PREMAKE_VERSION%;%PATH%"

before_build:
  # Build dependencies
  - engine\third-party\build_sfml.py
  # Premake
  - premake5 gmake

build_script:
  # Make (build dir must have been created by premake5)
  - pushd build
  # I don't know how to write `config=release make` in Batch, so just make
  # for debug config for now
  - make
  - popd
